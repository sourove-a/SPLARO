generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BLOCKED
  PENDING_VERIFICATION
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
}

enum OrderStatus {
  CREATED
  PAYMENT_PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  INITIATED
  PENDING
  PAID
  FAILED
  CANCELED
  REFUNDED
}

enum PaymentProvider {
  SSLCOMMERZ
  BKASH
  NAGAD
  STRIPE
  COD
}

enum PaymentMethod {
  CARD
  MOBILE_BANKING
  BANK_TRANSFER
  WALLET
  COD
}

enum ShipmentStatus {
  PENDING
  PICKED
  IN_TRANSIT
  DELIVERED
  RETURNED
  FAILED
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  PICKUP_SCHEDULED
  IN_TRANSIT
  RECEIVED
  REFUND_INITIATED
  REFUNDED
  CLOSED
}

enum RefundStatus {
  REQUESTED
  PROCESSING
  REFUNDED
  FAILED
  CANCELED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum CouponScopeType {
  ALL
  CATEGORY
  PRODUCT
}

enum AddressType {
  SHIPPING
  BILLING
}

enum NotificationType {
  ORDER_UPDATE
  PAYMENT_UPDATE
  RETURN_UPDATE
  REFUND_UPDATE
  COUPON
  PROMOTION
  SECURITY
  SYSTEM
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum TransactionEventType {
  PAYMENT_INITIATED
  PAYMENT_CALLBACK
  PAYMENT_WEBHOOK
  PAYMENT_VERIFIED
  PAYMENT_FAILED
  REFUND_INITIATED
  REFUND_COMPLETED
  REFUND_FAILED
}

enum OtpChannel {
  EMAIL
  SMS
}

enum OtpPurpose {
  REGISTER_VERIFY
  LOGIN_VERIFY
  PASSWORD_RESET
  TWO_FACTOR
}

model User {
  id                String       @id @default(cuid())
  email             String       @unique
  phone             String?      @unique
  passwordHash      String?
  fullName          String
  avatarUrl         String?
  status            UserStatus   @default(PENDING_VERIFICATION)
  emailVerifiedAt   DateTime?
  phoneVerifiedAt   DateTime?
  twoFactorEnabled  Boolean      @default(false)
  twoFactorSecret   String?
  lastLoginAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  deletedAt         DateTime?

  roles             UserRole[]
  assignedUserRoles UserRole[]   @relation("UserRoleAssignedBy")
  sessions          Session[]
  otpChallenges     OtpChallenge[]
  addresses         Address[]
  carts             Cart[]
  wishlist          Wishlist?
  orders            Order[]
  payments          Payment[]
  couponRedemptions CouponRedemption[]
  createdCoupons    Coupon[]     @relation("CouponCreator")
  reviews           Review[]
  moderatedReviews  Review[]     @relation("ReviewModerator")
  returnRequests    ReturnRequest[]
  processedRefunds  Refund[]     @relation("RefundProcessor")
  notifications     Notification[]
  auditLogs         AuditLog[]   @relation("AuditActor")

  @@index([status, createdAt])
  @@index([deletedAt])
}

model Role {
  id          String           @id @default(cuid())
  key         String           @unique
  name        String
  description String?
  isSystem    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String           @id @default(cuid())
  key         String           @unique
  name        String
  category    String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  roles       RolePermission[]

  @@index([category])
}

model UserRole {
  id           String    @id @default(cuid())
  userId       String
  roleId       String
  assignedById String?
  assignedAt   DateTime  @default(now())

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedBy   User?     @relation("UserRoleAssignedBy", fields: [assignedById], references: [id], onDelete: SetNull)

  @@unique([userId, roleId])
  @@index([roleId])
  @@index([assignedById])
}

model RolePermission {
  id            String      @id @default(cuid())
  roleId        String
  permissionId  String
  grantedAt     DateTime    @default(now())

  role          Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission    Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
}

model Session {
  id          String    @id @default(cuid())
  userId      String
  token       String    @unique
  ipAddress   String?
  userAgent   String?
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model OtpChallenge {
  id          String      @id @default(cuid())
  userId      String?
  identifier  String
  channel     OtpChannel
  purpose     OtpPurpose
  codeHash    String
  attempts    Int         @default(0)
  maxAttempts Int         @default(5)
  expiresAt   DateTime
  consumedAt  DateTime?
  createdAt   DateTime    @default(now())

  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([identifier, purpose, expiresAt])
  @@index([userId, purpose])
}

model Category {
  id             String      @id @default(cuid())
  name           String
  slug           String      @unique
  description    String?
  parentId       String?
  isActive       Boolean     @default(true)
  sortOrder      Int         @default(0)
  seoTitle       String?
  seoDescription String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  deletedAt      DateTime?

  parent         Category?   @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children       Category[]  @relation("CategoryTree")
  products       Product[]
  coupons        Coupon[]    @relation("CouponCategoryScope")

  @@index([parentId])
  @@index([isActive, sortOrder])
  @@index([deletedAt])
}

model Brand {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  products    Product[]

  @@index([isActive])
  @@index([deletedAt])
}

model Product {
  id               String         @id @default(cuid())
  name             String
  slug             String         @unique
  description      Json?
  shortDescription String?
  categoryId       String
  brandId          String?
  basePrice        Decimal        @db.Decimal(12, 2)
  currency         String         @default("BDT")
  isPublished      Boolean        @default(false)
  isFeatured       Boolean        @default(false)
  ratingAverage    Decimal        @default(0) @db.Decimal(3, 2)
  ratingCount      Int            @default(0)
  seoTitle         String?
  seoDescription   String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?

  category         Category       @relation(fields: [categoryId], references: [id])
  brand            Brand?         @relation(fields: [brandId], references: [id], onDelete: SetNull)
  variants         ProductVariant[]
  images           ProductImage[]
  orderItems       OrderItem[]
  wishlistItems    WishlistItem[]
  reviews          Review[]
  scopedCoupons    Coupon[]       @relation("CouponProductScope")

  @@index([categoryId, isPublished])
  @@index([brandId, isPublished])
  @@index([isFeatured, isPublished])
  @@index([deletedAt])
}

model ProductVariant {
  id             String         @id @default(cuid())
  productId      String
  sku            String         @unique
  title          String?
  size           String?
  color          String?
  price          Decimal        @db.Decimal(12, 2)
  compareAtPrice Decimal?       @db.Decimal(12, 2)
  weightGrams    Int?
  barcode        String?
  position       Int            @default(0)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  images         ProductImage[]
  inventory      Inventory?
  cartItems      CartItem[]
  orderItems     OrderItem[]
  wishlistItems  WishlistItem[]

  @@index([productId, isActive])
  @@index([size, color])
  @@index([deletedAt])
}

model ProductImage {
  id         String         @id @default(cuid())
  productId  String
  variantId  String?
  url        String
  alt        String?
  sortOrder  Int            @default(0)
  isPrimary  Boolean        @default(false)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  product    Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([productId, sortOrder])
  @@index([variantId])
}

model Inventory {
  id                String         @id @default(cuid())
  productVariantId  String         @unique
  stockOnHand       Int            @default(0)
  reservedStock     Int            @default(0)
  lowStockThreshold Int            @default(5)
  allowBackorder    Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  variant           ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  @@index([stockOnHand, reservedStock])
}

model Cart {
  id         String      @id @default(cuid())
  userId     String?
  guestToken String?
  status     CartStatus  @default(ACTIVE)
  currency   String      @default("BDT")
  expiresAt  DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  items      CartItem[]

  @@unique([guestToken])
  @@index([userId, status])
}

model CartItem {
  id          String         @id @default(cuid())
  cartId      String
  productId   String
  variantId   String
  quantity    Int
  unitPrice   Decimal        @db.Decimal(12, 2)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  cart        Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product     Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@unique([cartId, variantId])
  @@index([productId])
}

model Wishlist {
  id         String         @id @default(cuid())
  userId     String         @unique
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items      WishlistItem[]
}

model WishlistItem {
  id          String          @id @default(cuid())
  wishlistId  String
  productId   String
  variantId   String?
  createdAt   DateTime        @default(now())

  wishlist    Wishlist        @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product     Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([wishlistId, productId, variantId])
  @@index([productId])
}

model Address {
  id                String      @id @default(cuid())
  userId            String
  label             String?
  type              AddressType @default(SHIPPING)
  fullName          String
  phone             String
  country           String      @default("Bangladesh")
  state             String?
  city              String
  area              String?
  postalCode        String?
  line1             String
  line2             String?
  isDefaultShipping Boolean     @default(false)
  isDefaultBilling  Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?

  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders    Order[]     @relation("ShippingAddress")
  billingOrders     Order[]     @relation("BillingAddress")

  @@index([userId, type])
  @@index([deletedAt])
}

model Order {
  id               String         @id @default(cuid())
  orderNumber      String         @unique
  userId           String?
  status           OrderStatus    @default(CREATED)
  paymentStatus    PaymentStatus  @default(INITIATED)
  currency         String         @default("BDT")
  subtotal         Decimal        @db.Decimal(12, 2)
  discountTotal    Decimal        @default(0) @db.Decimal(12, 2)
  shippingTotal    Decimal        @default(0) @db.Decimal(12, 2)
  taxTotal         Decimal        @default(0) @db.Decimal(12, 2)
  grandTotal       Decimal        @db.Decimal(12, 2)
  couponCode       String?
  shippingAddressId String?
  billingAddressId String?
  notes            String?
  placedAt         DateTime       @default(now())
  paidAt           DateTime?
  completedAt      DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?

  user             User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  shippingAddress  Address?       @relation("ShippingAddress", fields: [shippingAddressId], references: [id], onDelete: SetNull)
  billingAddress   Address?       @relation("BillingAddress", fields: [billingAddressId], references: [id], onDelete: SetNull)
  items            OrderItem[]
  payments         Payment[]
  shipments        Shipment[]
  returnRequests   ReturnRequest[]
  couponRedemption CouponRedemption?
  refunds          Refund[]
  transactionLogs  TransactionLog[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([paymentStatus, createdAt])
  @@index([deletedAt])
}

model OrderItem {
  id             String         @id @default(cuid())
  orderId        String
  productId      String
  variantId      String
  productName    String
  variantName    String?
  sku            String
  unitPrice      Decimal        @db.Decimal(12, 2)
  quantity       Int
  discountAmount Decimal        @default(0) @db.Decimal(12, 2)
  lineTotal      Decimal        @db.Decimal(12, 2)
  isReturned     Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant        ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)
  reviews        Review[]
  returnRequests ReturnRequest[]
  shipmentItems  ShipmentItem[]

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model Payment {
  id                   String           @id @default(cuid())
  orderId              String
  userId               String?
  provider             PaymentProvider
  method               PaymentMethod
  status               PaymentStatus    @default(INITIATED)
  amount               Decimal          @db.Decimal(12, 2)
  currency             String           @default("BDT")
  gatewayTransactionId String?
  gatewayPaymentId     String?
  idempotencyKey       String           @unique
  signatureVerified    Boolean          @default(false)
  verifiedAt           DateTime?
  failureReason        String?
  rawPayload           Json?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  order                Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user                 User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  transactionLogs      TransactionLog[]
  refunds              Refund[]

  @@unique([provider, gatewayTransactionId])
  @@index([orderId, status])
  @@index([userId, createdAt])
}

model TransactionLog {
  id              String               @id @default(cuid())
  paymentId       String?
  orderId         String?
  refundId        String?
  eventType       TransactionEventType
  providerEventId String?
  idempotencyKey  String?
  requestPayload  Json?
  responsePayload Json?
  signatureValid  Boolean?
  createdAt       DateTime             @default(now())

  payment         Payment?             @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  order           Order?               @relation(fields: [orderId], references: [id], onDelete: SetNull)
  refund          Refund?              @relation(fields: [refundId], references: [id], onDelete: SetNull)

  @@unique([providerEventId])
  @@index([paymentId, createdAt])
  @@index([orderId, createdAt])
  @@index([refundId, createdAt])
  @@index([idempotencyKey])
}

model Coupon {
  id               String          @id @default(cuid())
  code             String          @unique
  name             String
  description      String?
  discountType     DiscountType
  discountValue    Decimal         @db.Decimal(12, 2)
  currency         String          @default("BDT")
  minOrderAmount   Decimal?        @db.Decimal(12, 2)
  maxDiscountAmount Decimal?       @db.Decimal(12, 2)
  usageLimit       Int?
  perUserLimit     Int?
  usedCount        Int             @default(0)
  startsAt         DateTime?
  expiresAt        DateTime?
  isActive         Boolean         @default(true)
  scopeType        CouponScopeType @default(ALL)
  scopeCategoryId  String?
  scopeProductId   String?
  createdById      String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?

  scopeCategory    Category?       @relation("CouponCategoryScope", fields: [scopeCategoryId], references: [id], onDelete: SetNull)
  scopeProduct     Product?        @relation("CouponProductScope", fields: [scopeProductId], references: [id], onDelete: SetNull)
  createdBy        User?           @relation("CouponCreator", fields: [createdById], references: [id], onDelete: SetNull)
  redemptions      CouponRedemption[]

  @@index([code, isActive])
  @@index([expiresAt, isActive])
  @@index([scopeCategoryId])
  @@index([scopeProductId])
  @@index([deletedAt])
}

model CouponRedemption {
  id             String    @id @default(cuid())
  couponId       String
  orderId        String    @unique
  userId         String?
  discountAmount Decimal   @db.Decimal(12, 2)
  redeemedAt     DateTime  @default(now())

  coupon         Coupon    @relation(fields: [couponId], references: [id], onDelete: Cascade)
  order          Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([couponId, redeemedAt])
  @@index([userId, redeemedAt])
}

model Review {
  id                String    @id @default(cuid())
  userId            String
  productId         String
  orderItemId       String?
  rating            Int
  title             String?
  comment           String?
  isVerifiedPurchase Boolean  @default(false)
  isApproved        Boolean   @default(false)
  moderatedById     String?
  moderatedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItem         OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: SetNull)
  moderatedBy       User?     @relation("ReviewModerator", fields: [moderatedById], references: [id], onDelete: SetNull)

  @@index([productId, isApproved, createdAt])
  @@index([userId, createdAt])
  @@index([deletedAt])
}

model ReturnRequest {
  id               String       @id @default(cuid())
  orderId          String
  orderItemId      String?
  userId           String
  reason           String
  details          String?
  evidenceUrls     Json?
  status           ReturnStatus @default(REQUESTED)
  requestedAt      DateTime     @default(now())
  approvedAt       DateTime?
  resolvedAt       DateTime?
  policyWindowDays Int?
  adminNote        String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem        OrderItem?   @relation(fields: [orderItemId], references: [id], onDelete: SetNull)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipment         Shipment?    @relation("ReturnShipment")
  refunds          Refund[]

  @@index([orderId, status])
  @@index([userId, requestedAt])
  @@index([status, requestedAt])
  @@index([deletedAt])
}

model Refund {
  id              String       @id @default(cuid())
  orderId         String
  returnRequestId String?
  paymentId       String?
  amount          Decimal      @db.Decimal(12, 2)
  currency        String       @default("BDT")
  status          RefundStatus @default(REQUESTED)
  reason          String?
  providerRefundId String?
  processedById   String?
  processedAt     DateTime?
  failureReason   String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  order           Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  returnRequest   ReturnRequest? @relation(fields: [returnRequestId], references: [id], onDelete: SetNull)
  payment         Payment?     @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  processedBy     User?        @relation("RefundProcessor", fields: [processedById], references: [id], onDelete: SetNull)
  transactionLogs TransactionLog[]

  @@unique([providerRefundId])
  @@index([orderId, status])
  @@index([returnRequestId])
  @@index([paymentId])
}

model Shipment {
  id                 String        @id @default(cuid())
  orderId            String
  returnRequestId    String?       @unique
  carrier            String?
  serviceLevel       String?
  trackingNumber     String?
  trackingUrl        String?
  status             ShipmentStatus @default(PENDING)
  shippedAt          DateTime?
  deliveredAt        DateTime?
  expectedDeliveryAt DateTime?
  meta               Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  order              Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  returnRequest      ReturnRequest? @relation("ReturnShipment", fields: [returnRequestId], references: [id], onDelete: SetNull)
  items              ShipmentItem[]

  @@unique([carrier, trackingNumber])
  @@index([orderId, status])
  @@index([status, updatedAt])
}

model ShipmentItem {
  id         String    @id @default(cuid())
  shipmentId String
  orderItemId String
  quantity   Int
  createdAt  DateTime  @default(now())

  shipment   Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  orderItem  OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([shipmentId, orderItemId])
  @@index([orderItemId])
}

model Notification {
  id         String             @id @default(cuid())
  userId     String?
  type       NotificationType
  channel    NotificationChannel
  status     NotificationStatus @default(PENDING)
  title      String
  message    String
  payload    Json?
  isRead     Boolean            @default(false)
  readAt     DateTime?
  sentAt     DateTime?
  failedAt   DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  user       User?              @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, isRead, createdAt])
  @@index([status, createdAt])
}

model AuditLog {
  id         String    @id @default(cuid())
  actorUserId String?
  entityType String
  entityId   String?
  action     String
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime  @default(now())

  actor      User?     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([actorUserId, createdAt])
  @@index([entityType, entityId])
  @@index([action, createdAt])
}
